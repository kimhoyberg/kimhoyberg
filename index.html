<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kim Hoyberg</title>

<link rel="stylesheet" href="shared.css">

<style>
/* Turn-Timer styles */
:root { --timer-accent: #ececec; }
#turn-timer h3{margin-bottom:6px;}
#turn-timer p{margin-top:0;margin-bottom:12px;}
#turn-timer label{margin-bottom:6px;}
#timeDisplay{font-size:3rem;font-weight:600;margin:0.75rem 0}
.controls{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:flex-start;margin-bottom:8px;}
button{font-size:1rem;padding:0.4rem 0.8rem;border:1px solid #cccccc;border-radius:16px;background:#fff;cursor:pointer}
input[type="number"]{font-size:1rem;padding:0.4rem 0.8rem;border:1px solid #cccccc;border-radius:16px;background:#fff;cursor:pointer}
button:hover{background:var(--timer-accent)}
label{display:flex;align-items:center;gap:0.4rem;}
.left-align{justify-content:flex-start; text-align:left;}
#status{margin-top:0.5rem;font-size:0.95rem;min-height:1.2rem}
#awakeStatus{font-size:0.85rem;color:#666;margin-top:0.3rem;min-height:1em}
</style>
</head>
<body>
<main>
  <!-- Hero -->
  <img src="pfp-ghibli.png" alt="Illustrated portrait of me" class="portrait" />
  <h1>Kim Hoyberg</h1>
  <p>
    <a href="https://thewayofcode.com" class="vibe-link" target="_blank">Vibe coding</a> solutions to everyday problems.
  </p>
  <p>
    <a href="mailto:kim@kpeconsult.dk" class="reach-out-btn">Reach out</a>
  </p>

  <!-- Turn-Timer -->
  <section id="turn-timer" style="margin-top:48px;">
    <h2>üêü Tuna-Timer</h2>
    <p>A simple turn timer that loops automatically when time runs out, perfect for games and activities.</p>
    <label>
      Minutes per turn:
      <input id="minutesInput" type="number" min="1" value="10" />
    </label>
    <div id="timeDisplay">10:00</div>
    <div class="controls">
      <button id="startPauseBtn">‚ñ∂Ô∏è Start</button>
      <button id="resetBtn">‚èπÔ∏è Reset</button>
      <button id="testSoundBtn">üîä Test Sound</button>
    </div>
    <label class="left-align">
      <input id="keepAwakeToggle" type="checkbox">
      Keep screen awake
    </label>
    <div id="awakeStatus"></div>
    <div id="status"></div>
  </section>
</main>
<script>
(() => {
  const minutesInput   = document.getElementById('minutesInput');
  const timeDisplay    = document.getElementById('timeDisplay');
  const startPauseBtn  = document.getElementById('startPauseBtn');
  const resetBtn       = document.getElementById('resetBtn');
  const status         = document.getElementById('status');
  const testSoundBtn   = document.getElementById('testSoundBtn');
  const keepAwakeToggle= document.getElementById('keepAwakeToggle');
  const awakeStatus    = document.getElementById('awakeStatus');

  let totalSecs = 600;
  let remaining = totalSecs;
  let ticking   = false;
  let endTime   = null;
  let timerLoopPromise = null;

  // Safari-compatible audio using Web Audio API with fallback
  let audioCtx = null;

  // Safari detection
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  // Initialize audio for Safari (requires user interaction)
  let audioInitialized = false;

  function initializeAudio() {
    if (!audioInitialized) {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioInitialized = true;
      } catch (error) {
        console.error('Audio context creation failed:', error);
      }
    }
  }

  function ding() {
    try {
      if (!audioCtx) {
        console.error('Audio context not initialized');
        return;
      }

      // Resume AudioContext if suspended (Safari/iOS)
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          playBeep();
        }).catch(error => {
          console.error('Audio resume failed:', error);
        });
      } else {
        playBeep();
      }
    } catch (error) {
      console.error('Audio error:', error);
    }
  }

  function playBeep() {
    try {
      const now = audioCtx.currentTime;
      const masterGain = audioCtx.createGain();
      masterGain.gain.setValueAtTime(0.3, now);
      masterGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);

      const osc = audioCtx.createOscillator();
      osc.type = 'square';
      osc.frequency.value = 800; // Simple beep frequency
      osc.connect(masterGain);
      osc.start(now);
      osc.stop(now + 0.3);

      masterGain.connect(audioCtx.destination);
    } catch (error) {
      console.error('Beep play failed:', error);
    }
  }

  function updateDisplay() {
    const m = Math.floor(remaining/60).toString().padStart(2,'0');
    const s = (remaining%60).toString().padStart(2,'0');
    timeDisplay.textContent = `${m} : ${s}`;
  }

  function setTotalSeconds() {
    const mVal = Math.max(1, parseInt(minutesInput.value, 10) || 10);
    totalSecs  = mVal * 60;
    remaining  = totalSecs;
    updateDisplay();
    status.textContent = '';
    endTime = null;
  }

  let timerInterval = null;

  function startTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
    }

    const startTime = Date.now();
    endTime = startTime + remaining * 1000;

    timerInterval = setInterval(() => {
      if (!ticking) {
        clearInterval(timerInterval);
        return;
      }

      const now = Date.now();
      remaining = Math.max(0, Math.round((endTime - now) / 1000));
      updateDisplay();

      if (remaining <= 0) {
        // Timer completed
        clearInterval(timerInterval);
        timerInterval = null;

        // Play sound and vibrate
        ding();
        if (navigator.vibrate) navigator.vibrate([120,60,120]);

        // Reset for next loop
        setTotalSeconds();

        // Restart timer after a delay
        setTimeout(() => {
          if (ticking) {
            startTimer();
          }
        }, isSafari ? 200 : 100);
      }
    }, 250);
  }

  function start() {
    const now = Date.now();
    endTime = now + remaining * 1000;
    ticking = true;
    startPauseBtn.textContent = '‚è∏Ô∏è Pause';
    status.textContent = 'Running‚Ä¶';
    startTimer();
  }

  function pause() {
    ticking = false;
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    if (endTime) {
      remaining = Math.max(0, Math.round((endTime - Date.now()) / 1000));
    }
    startPauseBtn.textContent = '‚ñ∂Ô∏è Start';
    status.textContent = 'Paused';
  }

  // --- Screen Wake Lock ---
  let wakeLock = null;
  async function requestWakeLock() {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      awakeStatus.textContent = 'Screen will stay awake.';
      wakeLock.addEventListener('release', () => {
        awakeStatus.textContent = 'Wake lock released by system.';
        keepAwakeToggle.checked = false;
      });
    } catch (err) {
      awakeStatus.textContent = 'Wake lock failed: ' + err.message;
      keepAwakeToggle.checked = false;
    }
  }
  async function releaseWakeLock() {
    try {
      if (wakeLock) { await wakeLock.release(); wakeLock = null; }
      awakeStatus.textContent = 'Screen may sleep normally.';
    } catch (err) {
      awakeStatus.textContent = 'Error releasing wake lock: ' + err.message;
    }
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && keepAwakeToggle.checked) {
      requestWakeLock();
    }
  });
  keepAwakeToggle.addEventListener('change', async e => {
    if ('wakeLock' in navigator) {
      e.target.checked ? await requestWakeLock() : await releaseWakeLock();
    } else {
      awakeStatus.textContent = 'Wake Lock API not supported on this browser.';
      e.target.checked = false;
    }
  });

  // UI wiring
  minutesInput.addEventListener('change', () => {
    const wasRunning = ticking;
    pause();
    setTotalSeconds();
    if (wasRunning) start();
  });
  startPauseBtn.addEventListener('click', () => {
    initializeAudio(); // Initialize audio on first user interaction
    ticking ? pause() : start();
  });
  resetBtn.addEventListener('click', () => {
    initializeAudio(); // Initialize audio on first user interaction
    pause();
    setTotalSeconds();
  });
  testSoundBtn.addEventListener('click', () => {
    initializeAudio(); // Initialize audio on first user interaction
    ding();
  });

  setTotalSeconds();
})();
</script>
</body>
</html> 