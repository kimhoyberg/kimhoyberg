<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tuna-Timer</title>
<link rel="stylesheet" href="../shared.css">
<style>
  :root { --accent: #ececec; } /* Local accent for button hover */

  /* Unique Tuna-Timer styles only */
  img#hero {
  width: 100%;
  max-width: 100%;
  height: auto;
  border-radius: 24px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  margin-bottom: 1.5rem;
}
  
  /* Remove h1 style to use only shared.css */
  #timeDisplay{font-size:3rem;font-weight:600;margin:1rem 0}
  .controls{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:flex-start;margin-bottom:18px;}
  
  button,input[type="number"]{font-size:1.0rem;padding:0.4rem 0.8rem;border:1px solid #cccccc;border-radius:16px;background:#fff;cursor:pointer}
  
  button:hover{background:var(--accent)}
  
  label{display:flex;align-items:center;gap:0.4rem;}
  .left-align{justify-content:flex-start; text-align:left;}
  #status{margin-top:0.5rem;font-size:0.95rem;min-height:1.2rem}
  #awakeStatus{font-size:0.85rem;color:#666;margin-top:0.3rem;min-height:1em}
</style>
</head>
<body>
<nav class="nav-bar">
  <div class="nav-container">
    <a href="../" class="nav-link">Home</a>
  </div>
</nav>
<main>
  <img id="hero" src="tuna.jpg" alt="Jumping tuna" />
  <h1>Tuna-Timer üêü‚è∞</h1>
  <p>A simple turn timer that loops automatically when time runs out, perfect for games and activities.</p>
  <label>
    Minutes per turn:
    <input id="minutesInput" type="number" min="1" value="10" />
  </label>
  <div id="timeDisplay">10:00</div>
  <div class="controls">
    <button id="startPauseBtn">‚ñ∂Ô∏è Start</button>
    <button id="resetBtn">‚èπÔ∏è Reset</button>
    <button id="testSoundBtn">üîä Test Sound</button>
  </div>
  <label class="left-align">
    <input id="keepAwakeToggle" type="checkbox">
    Keep screen awake
  </label>
  <div id="awakeStatus"></div>
  <div id="status"></div>
</main>
<script>
(() => {
  const minutesInput   = document.getElementById('minutesInput');
  const timeDisplay    = document.getElementById('timeDisplay');
  const startPauseBtn  = document.getElementById('startPauseBtn');
  const resetBtn       = document.getElementById('resetBtn');
  const status         = document.getElementById('status');
  const testSoundBtn   = document.getElementById('testSoundBtn');
  const keepAwakeToggle= document.getElementById('keepAwakeToggle');
  const awakeStatus    = document.getElementById('awakeStatus');

  let totalSecs = 600;
  let remaining = totalSecs;
  let ticking   = false;
  let endTime   = null;
  let timerLoopPromise = null;

  // --- LOUDER / HIGHER SOUND ---
  // Safari-compatible audio using HTML5 Audio instead of Web Audio API
  const audio = new Audio();
  audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';
  audio.volume = 0.7;
  
  // Safari detection
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  
  // Initialize audio for Safari (requires user interaction)
  let audioInitialized = false;
  
  function initializeAudio() {
    if (!audioInitialized && isSafari) {
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        audioInitialized = true;
      }).catch(error => {
        console.error('Audio initialization failed:', error);
      });
    }
  }
  
  function ding() {
    try {
      // For Safari, we need to reset the audio before playing
      if (isSafari) {
        audio.currentTime = 0;
      }
      
      // Try to play audio
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.error('Audio play failed:', error);
          // For Safari, try to reinitialize audio
          if (isSafari && !audioInitialized) {
            initializeAudio();
          }
        });
      }
    } catch (error) {
      console.error('Audio error:', error);
    }
  }

  function updateDisplay() {
    const m = Math.floor(remaining/60).toString().padStart(2,'0');
    const s = (remaining%60).toString().padStart(2,'0');
    timeDisplay.textContent = `${m} : ${s}`;
  }

  function setTotalSeconds() {
    const mVal = Math.max(1, parseInt(minutesInput.value, 10) || 10);
    totalSecs  = mVal * 60;
    remaining  = totalSecs;
    updateDisplay();
    status.textContent = '';
    endTime = null;
  }

  let timerInterval = null;

  function startTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    
    const startTime = Date.now();
    endTime = startTime + remaining * 1000;
    
    timerInterval = setInterval(() => {
      if (!ticking) {
        clearInterval(timerInterval);
        return;
      }
      
      const now = Date.now();
      remaining = Math.max(0, Math.round((endTime - now) / 1000));
      updateDisplay();
      
      if (remaining <= 0) {
        // Timer completed
        clearInterval(timerInterval);
        timerInterval = null;
        
        // Play sound and vibrate
        ding();
        if (navigator.vibrate) navigator.vibrate([120,60,120]);
        
        // Reset for next loop
        setTotalSeconds();
        
        // Restart timer after a delay
        setTimeout(() => {
          if (ticking) {
            startTimer();
          }
        }, isSafari ? 200 : 100);
      }
    }, 250);
  }

  function start() {
    const now = Date.now();
    endTime = now + remaining * 1000;
    ticking = true;
    startPauseBtn.textContent = '‚è∏Ô∏è Pause';
    status.textContent = 'Running‚Ä¶';
    startTimer();
  }

  function pause() {
    ticking = false;
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    if (endTime) {
      remaining = Math.max(0, Math.round((endTime - Date.now()) / 1000));
    }
    startPauseBtn.textContent = '‚ñ∂Ô∏è Start';
    status.textContent = 'Paused';
  }

  // --- Screen Wake Lock ---
  let wakeLock = null;
  async function requestWakeLock() {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      awakeStatus.textContent = 'Screen will stay awake.';
      wakeLock.addEventListener('release', () => {
        awakeStatus.textContent = 'Wake lock released by system.';
        keepAwakeToggle.checked = false;
      });
    } catch (err) {
      awakeStatus.textContent = 'Wake lock failed: ' + err.message;
      keepAwakeToggle.checked = false;
    }
  }
  async function releaseWakeLock() {
    try {
      if (wakeLock) { await wakeLock.release(); wakeLock = null; }
      awakeStatus.textContent = 'Screen may sleep normally.';
    } catch (err) {
      awakeStatus.textContent = 'Error releasing wake lock: ' + err.message;
    }
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && keepAwakeToggle.checked) {
      requestWakeLock();
    }
  });
  keepAwakeToggle.addEventListener('change', async e => {
    if ('wakeLock' in navigator) {
      e.target.checked ? await requestWakeLock() : await releaseWakeLock();
    } else {
      awakeStatus.textContent = 'Wake Lock API not supported on this browser.';
      e.target.checked = false;
    }
  });

  // UI wiring
  minutesInput.addEventListener('change', () => {
    const wasRunning = ticking;
    pause();
    setTotalSeconds();
    if (wasRunning) start();
  });
  startPauseBtn.addEventListener('click', () => {
    initializeAudio(); // Initialize audio on first user interaction
    ticking ? pause() : start();
  });
  resetBtn.addEventListener('click', () => { 
    initializeAudio(); // Initialize audio on first user interaction
    pause(); 
    setTotalSeconds(); 
  });
  testSoundBtn.addEventListener('click', () => {
    initializeAudio(); // Initialize audio on first user interaction
    ding();
  });

  setTotalSeconds();
})();
</script>
</body>
</html> 